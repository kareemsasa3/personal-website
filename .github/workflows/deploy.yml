name: CD - Deploy to Production

on:
  workflow_run:
    workflows: ["CI - Build Workfolio"]
    types:
      - completed

jobs:
  deploy:
    # This job only runs if the CI workflow was successful on the main/master branch
    if: ${{ github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to checkout the repo and read the composite action
      packages: read # Required for GHCR login, though token handles auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # No fetch-depth needed as we get the SHA from the workflow_run event

      # The composite action now handles all SSH and deployment logic.
      # The old "Configure SSH" and "Set image tags env" steps are no longer needed.
      - name: SSH Deploy (composite)
        uses: ./.github/actions/ssh-deploy
        with:
          host: ${{ secrets.PROD_HOST }}
          user: ${{ secrets.PROD_USER }}
          port: ${{ secrets.PROD_PORT }}
          ssh_key: ${{ secrets.PROD_SSH_KEY }}
          ghcr_username: ${{ secrets.GHCR_USERNAME }}
          ghcr_token: ${{ secrets.GHCR_TOKEN }}
          repository: ${{ github.repository }}
          # We get the commit SHA from the triggering CI workflow run
          sha: ${{ github.event.workflow_run.head_sha }}
